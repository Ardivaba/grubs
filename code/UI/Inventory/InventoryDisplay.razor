@namespace Grubs.UI.Inventory

@using Grubs.Equipment
@using Grubs.Equipment.Weapons
@using Grubs.Pawn
@using Grubs.UI.Components
@using Sandbox;
@using Sandbox.UI

@inherits Panel

@attribute [StyleSheet]

@if (Inventory is null)
{
    return;
}

<root>
    @for (var i = 0; i < _rows; i++)
    {
        <div class="inv-row">
            @for (var j = 0; j < _columns; j++)
            {
                <InventoryItem Equipment=@Inventory.Equipment.ElementAtOrDefault(i * _columns + j) />
            }
        </div>
    }
</root>

@code
{
    public PlayerInventory Inventory { get; set; }

    private Equipment Current => Inventory.Equipment.ElementAtOrDefault(Inventory.ActiveSlot);
    private Equipment Next => Inventory.Equipment.ElementAtOrDefault(Inventory.GetNextSlot());
    private Equipment Prev => Inventory.Equipment.ElementAtOrDefault(Inventory.GetPrevSlot());
    private Weapon CurrentWeapon => Current?.Components.Get<Weapon>();
    private Weapon NextWeapon => Next?.Components.Get<Weapon>();
    private Weapon PrevWeapon => Prev?.Components.Get<Weapon>();

    private const int _columns = 4;
    private int _rows => (int)Math.Ceiling((float)_totalItems / _columns);
    private int _totalItems => Inventory.Equipment.Count();

    private int _currentGamepadIndex = 0;
    private bool _usedJoystick;

    public override void Tick()
    {
        SetClass("hide", !Inventory.InventoryOpen);
        Cursor.Enabled("inv", Inventory.InventoryOpen);

        if (!Input.UsingController) return;

        if (Inventory.InventoryOpen && Math.Round(Input.AnalogMove.Length) != 0 && !_usedJoystick)
        {
            _usedJoystick = true;
            PlayerInventory.Local.EquipItem(Inventory.Equipment.ElementAtOrDefault(SelectNextItemGamepadInput()));
        }

        if (Inventory.InventoryOpen && Math.Round(Input.AnalogMove.Length) == 0 && _usedJoystick)
        {
            _usedJoystick = false;
        }
    }

    protected override int BuildHash()
    {
        var cd = CurrentWeapon?.TimeSinceLastUsed + PrevWeapon?.TimeSinceLastUsed + NextWeapon?.TimeSinceLastUsed;
        return HashCode.Combine(Inventory.EquipmentActive, Inventory.ActiveSlot, cd);
    }

    private int SelectNextItemGamepadInput()
    {
        float analogX = Input.AnalogMove.x;
        float analogY = -Input.AnalogMove.y;

        int currentRow = _currentGamepadIndex / _columns;
        int currentColumn = _currentGamepadIndex % _columns;

        if (analogX > 0)
        {
            currentRow = (currentRow - 1 + _rows) % _rows;
        }
        else if (analogX < 0)
        {
            currentRow = (currentRow + 1) % _rows;
        }

        if (analogY < 0)
        {
            currentColumn = (currentColumn - 1 + _columns) % _columns;
        }
        else if (analogY > 0)
        {
            currentColumn = (currentColumn + 1) % _columns;
        }
        _currentGamepadIndex = currentRow * _columns + currentColumn;

        return _currentGamepadIndex;
    }
}