@namespace Grubs.UI

@using Grubs.Player
@using Sandbox;
@using Sandbox.UI;
@using Sandbox.Utility

@inherits PanelComponent

<root>
    <div class="top">

        <div class="hp" style="background-color: @Color.Hex">
            <label>
                @_health.CeilToInt()
            </label>
            <i>favorite</i>
        </div>
    </div>
    <div
        class="title"
        style="background-image: linear-gradient(@Color.Hex, adjust-hue(@Color.Hex, 45));
               border-bottom-color: darken(adjust-hue(@Color.Hex, 45), 50%)">
        @* <div class="avi"> *@
        @*     <image *@
        @*         src="avatar:@(Grub.Network.OwnerConnection?.SteamId ?? Steam.SteamId)" *@
        @*         style="background-color: @Color.Hex; border-color: @Color.Hex"/> *@
        @* </div> *@
        @Grub.Name
    </div>
</root>

@code
{
    [Property] public required Grub Grub { get; set; }
    [Property] public Color Color { get; set; }

    private float _health;
    private const float _transitionRate = 25f;

    protected override void OnStart()
    {
        base.OnStart();

        Transform.Position = Grub.Transform.Position + Vector3.Up * 44f;
        _health = Grub.Health.CurrentHealth;
    }

    protected override void OnUpdate()
    {
        if (_health != Grub.Health.CurrentHealth)
        {
            var delta = Grub.Health.CurrentHealth < _health ? -1 : 1;
            var health = _health + delta * Time.Delta * _transitionRate;
            _health = health.Clamp(Math.Min(_health, Grub.Health.CurrentHealth), Math.Max(_health, Grub.Health.CurrentHealth));
        }
    }

    /// <summary>
    /// the hash determines if the system should be rebuilt. If it changes, it will be rebuilt
    /// </summary>
    protected override int BuildHash()
    {
        return HashCode.Combine(Grub.Name, Grub.Health.CurrentHealth, _health, Color.Hex);
    }
}